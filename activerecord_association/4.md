# 4 个关联类方法

Rails 提供了 4 个类方法，用于声明对象与对象之间的关系。它们的意思，理解起来很简单，和字面意思一样，如"Project has one Project Manager" 或 "Project belongs to a Portfolio".   但实际使用过程，还是有很多要注意的。不同的场景，需要不同的参数；并且，它们会引入一些额外的方法，有的和 attr_* 类似，但有的不是。

```ruby
class Project < ActiveRecord::Base
  belongs_to              :portfolio
  has_one                 :project_manager
  has_many                :milestones
  has_and_belongs_to_many :categories
end
```

上面例子里的场景最简单，不需要带任何参数；下面是它们引入的额外的方法，包括但不限于：

```ruby
# 1
Project#portfolio, Project#portfolio=(portfolio), Project#portfolio.nil?

# 2
Project#project_manager, Project#project_manager=(project_manager), Project#project_manager.nil?,

# 3
Project#milestones.empty?, Project#milestones.size, Project#milestones, Project#milestones<<(milestone), Project#milestones.delete(milestone), Project#milestones.destroy(milestone), Project#milestones.find(milestone_id), Project#milestones.build, Project#milestones.create

# 4
Project#categories.empty?, Project#categories.size, Project#categories, Project#categories<<(category1), Project#categories.delete(category1), Project#categories.destroy(category1)
```

## 1) belongs_to

### 方法本身表示什么意思。

指定一对一关系。如果，"前者 belongs_to 后者"，那么'前者'需要包括'后者_id'属性。

### 引进了哪些方法，表示什么意思。

|方法|解释|
|--|--|
|association(force_reload = false)|返回后者。如果没有的话，返回 nil.|
|association=(associate)|给后者赋值。这里会自动设置'后者_id'属性|
|build_association(attributes = {})|构建并返回后者。这里后者还未保存在数据库。|
|create_association(attributes = {})|创建并返回后者。这里后者会被保存在数据库(如果校验没有问题的话)|
|create_association!(attributes = {})|和 create_association 类似, 但如果创建失败会报错 ActiveRecord::RecordInvalid.|

后面几个方法，作用类似，只是细节部分有所不同，使用时注意一下即可。

### 有什么参数，表示什么意思，使用后有什么效果。

普通参数 **Scope**

设置一个 scope，通过前者查询后者的时候(其它时候不影响)，自动加到查询语句里。(类似在后者 model 里定义了一个 default_scope，但只有通过前者查询才起作用)

Scope examples:

```ruby
belongs_to :user, -> { where(id: 2) }
belongs_to :user, -> { joins(:friends) }
belongs_to :level, ->(level) { where("game_level > ?", level.current) }
```

可选参数 **Options**

| 参数 | 解释 |
| -- | -- |
| :class_name | 后者对应着一个 model. 当按照"约定"找不到这个 model 的时候，用 :class_name 指明。|
| :foreign_key | 前者包含了"后者_id"属性，这个属性是按照"约定"命名的，如果不符合"约定"，用 :foreign_key 指明。|
| :foreign_type | 多态时，前者同时包含"后者_id"和"后者_type"属性。当"后者_type"不符合"约定"时，用 :foreign_type 指明。|
| :primary_key | 凡是通过前者查询后者 - "前者.后者"。默认"后者_id"属性对应着后者的 id 属性，如果觉得不合适，可以用 :primary_key 指明。|
| :dependent | 如果设置为 :destroy, 前者被删除时，后者也会同时被 destroy. 如果设置为 :delete, 前者被删除时，后者也会同时被 delete. |
| :counter_cache | 设置为 true 后，创建或删除一个前者，会相应的调用 increment_counter 或 decrement_counter 来改变后者计数器的值。默认是 false，也就是不起作用。|
| :polymorphic | 声明 belongs_to 关联是多态的。|
| :validate | 设置为 true, 保存后者的时候会先对所有前者进行校验。默认是 false, 也就是不起作用。|
| :autosave | 设置为 true, 保存后者时会自动保存所有前者，destroy 后者时会自动删除所有前者。设置为 false 还可分为两种情况：前者为 new_record，则保存后者时会自动保存前者；否则上述自动操作都不会被执行。|
| :touch | If true, the associated object will be touched (the updated_at/on attributes set to current time) when this record is either saved or destroyed. If you specify a symbol, that attribute will be updated with the current time in addition to the updated_at/on attribute. |
| :inverse_of | Specifies the name of the has_one or has_many association on the associated object that is the inverse of this belongs_to association. Does not work in combination with the :polymorphic options. See ActiveRecord::Associations::ClassMethods's overview on Bi-directional associations for more detail. |
| :required | When set to true, the association will also have its presence validated. This will validate the association itself, not the id. You can use :inverse_of to avoid an extra query during validation. |

### 注意事项。

- If the other class contains the foreign key, then you should use has_one instead.
- `:class_name` 不影响 `:foreign_key` "后者_id"属性的命名约定。
- 当后者与前者的关系是 has_many 时，请慎用 `:dependent`. 因为后者被同时删除的话，剩下的前者将成为孤儿(没有前者可关联)。
- `:counter_cache` 计数器是根据"前者对应的 table_name + count"生成的，如里不符合"约定"，可以用 :counter_cache 指明。自定义计数器名字的时候，建议把此属性声明为 attr_readonly. 综上，:counter_cache 可以设置为 true、false、或自定义的名字。
- `:polymorphic` 如果你同时使用了 `:counter_cache`，建议在后者的 model 里把计数器设置为 attr_readonly.
- 综上两条注意事项，有两种情况建议在后者的 model 里手动把计数器设置为 attr_readonly.
- `:validate` 对于是否是 new_record 在做 valid? 时，会造成迷惑。牢记，`:validate` 意味着对前者和后者都有"保存"操作。如果校验失败，则本次保存失败。
- `:autosave` 如果在 model 里使用了 accepts_nested_attributes_for，则对应 `:autosave` 始终为 true.

## 2) has_one

### 方法本身表示什么意思。

Specifies a one-to-one association with another class. This method should only be used if the other class contains the foreign key.

### 引进了哪些方法，表示什么意思。

| 方法 | 解释 |
| -- | -- |
| association(force_reload = false) | Returns the associated object. nil is returned if none is found. |
| association=(associate) | Assigns the associate object, extracts the primary key, sets it as the foreign key, and saves the associate object. To avoid database inconsistencies, permanently deletes an existing associated object when assigning a new one, even if the new one isn't saved to database. |
| build_association(attributes = {}) | Returns a new object of the associated type that has been instantiated with attributes and linked to this object through a foreign key, but has not yet been saved. |
| create_association(attributes = {}) | Returns a new object of the associated type that has been instantiated with attributes, linked to this object through a foreign key, and that has already been saved (if it passed the validation). |
| create_association!(attributes = {}) | Does the same as create_association, but raises ActiveRecord::RecordInvalid if the record is invalid. |

### 有什么参数，表示什么意思，使用后有什么效果。

普通参数 **Scope**

You can pass a second argument scope as a callable (i.e. proc or lambda) to retrieve a specific record or customize the generated query when you access the associated object.

Scope examples:

```ruby
has_one :author, -> { where(comment_id: 1) }
has_one :employer, -> { joins(:company) }
has_one :dob, ->(dob) { where("Date.new(2000, 01, 01) > ?", dob) }
```

可选参数 **Options**

| 参数 | 解释 |
| -- | -- |
| :class_name | Specify the class name of the association. Use it only if that name can't be inferred from the association name. So has_one :manager will by default be linked to the Manager class, but if the real class name is Person, you'll have to specify it with this option. |
| :dependent | Controls what happens to the associated object when its owner is destroyed: |
| :foreign_key | Specify the foreign key used for the association. By default this is guessed to be the name of this class in lower-case and “_id” suffixed. So a Person class that makes a has_one association will use “person_id” as the default :foreign_key. |
| :primary_key | Specify the method that returns the primary key used for the association. By default this is id. |
| :as | Specifies a polymorphic interface (See belongs_to). |
| :through | Specifies a Join Model through which to perform the query. Options for :class_name, :primary_key, and :foreign_key are ignored, as the association uses the source reflection. You can only use a :through query through a has_one or belongs_to association on the join model. |
| :source | Specifies the source association name used by has_one :through queries. Only use it if the name cannot be inferred from the association. has_one :favorite, through: :favorites will look for a :favorite on Favorite, unless a :source is given. |
| :source_type | Specifies type of the source association used by has_one :through queries where the source association is a polymorphic belongs_to. |
| :validate | If false, don't validate the associated object when saving the parent object. false by default. |
| :autosave | If true, always save the associated object or destroy it if marked for destruction, when saving the parent object. If false, never save or destroy the associated object. By default, only save the associated object if it's a new record. <br> Note that accepts_nested_attributes_for sets :autosave to true. |
| :inverse_of | Specifies the name of the belongs_to association on the associated object that is the inverse of this has_one association. Does not work in combination with :through or :as options. See ActiveRecord::Associations::ClassMethods's overview on Bi-directional associations for more detail. |
| :required | When set to true, the association will also have its presence validated. This will validate the association itself, not the id. You can use :inverse_of to avoid an extra query during validation. |

### 注意事项。

- :dependent
  - :destroy causes the associated object to also be destroyed
  - :delete causes the associated object to be deleted directly from the database (so callbacks will not execute)
  - :nullify causes the foreign key to be set to NULL. Callbacks are not executed.
  - :restrict_with_exception causes an exception to be raised if there is an associated record
  - :restrict_with_error causes an error to be added to the owner if there is an associated object

## 3) has_many

### 方法本身表示什么意思。

Specifies a one-to-many association.

### 引进了哪些方法，表示什么意思。

| 方法 | 解释 |
| -- | -- |
| collection(force_reload = false) | Returns an array of all the associated objects. An empty array is returned if none are found. |
| collection<<(object, …) | Adds one or more objects to the collection by setting their foreign keys to the collection's primary key. Note that this operation instantly fires update SQL without waiting for the save or update call on the parent object, unless the parent object is a new record. |
| collection.delete(object, …) | Removes one or more objects from the collection by setting their foreign keys to NULL. Objects will be in addition destroyed if they're associated with dependent: :destroy, and deleted if they're associated with dependent: :delete_all. <br> If the :through option is used, then the join records are deleted (rather than nullified) by default, but you can specify dependent: :destroy or dependent: :nullify to override this. |
| collection.destroy(object, …) | Removes one or more objects from the collection by running destroy on each record, regardless of any dependent option, ensuring callbacks are run. <br> If the :through option is used, then the join records are destroyed instead, not the objects themselves. |
| collection=objects | Replaces the collections content by deleting and adding objects as appropriate. If the :through option is true callbacks in the join models are triggered except destroy callbacks, since deletion is direct. |
| collection_singular_ids | Returns an array of the associated objects' ids |
| collection_singular_ids=ids | Replace the collection with the objects identified by the primary keys in ids. This method loads the models and calls collection=. See above. |
| collection.clear | Removes every object from the collection. This destroys the associated objects if they are associated with dependent: :destroy, deletes them directly from the database if dependent: :delete_all, otherwise sets their foreign keys to NULL. If the :through option is true no destroy callbacks are invoked on the join models. Join models are directly deleted. |
| collection.empty? | Returns true if there are no associated objects. |
| collection.size | Returns the number of associated objects. |
| collection.find(…) | Finds an associated object according to the same rules as ActiveRecord::Base.find. |
| collection.exists?(…) | Checks whether an associated object with the given conditions exists. Uses the same rules as ActiveRecord::Base.exists?. |
| collection.build(attributes = {}, …) | Returns one or more new objects of the collection type that have been instantiated with attributes and linked to this object through a foreign key, but have not yet been saved. |
| collection.create(attributes = {}) | Returns a new object of the collection type that has been instantiated with attributes, linked to this object through a foreign key, and that has already been saved (if it passed the validation). Note: This only works if the base model already exists in the DB, not if it is a new (unsaved) record! |
| collection.create!(attributes = {}) | Does the same as collection.create, but raises ActiveRecord::RecordInvalid if the record is invalid. |

### 有什么参数，表示什么意思，使用后有什么效果。

普通参数 **Scope**

You can pass a second argument scope as a callable (i.e. proc or lambda) to retrieve a specific set of records or customize the generated query when you access the associated collection.

Scope examples:

```ruby
has_many :comments, -> { where(author_id: 1) }
has_many :employees, -> { joins(:address) }
has_many :posts, ->(post) { where("max_post_length > ?", post.length) }
```

普通参数 **Extension**

The extension argument allows you to pass a block into a #has_many association. This is useful for adding new finders, creators and other factory-type methods to be used as part of the association.

Extension examples:

```ruby
has_many :employees do
  def find_or_create_by_name(name)
    first_name, last_name = name.split(" ", 2)
    find_or_create_by(first_name: first_name, last_name: last_name)
  end
end
```

可选参数 **Options**

| 参数 | 解释 |
| -- | -- |
| :class_name | Specify the class name of the association. Use it only if that name can't be inferred from the association name. So has_many :products will by default be linked to the Product class, but if the real class name is SpecialProduct, you'll have to specify it with this option. |
| :foreign_key | Specify the foreign key used for the association. By default this is guessed to be the name of this class in lower-case and “_id” suffixed. So a Person class that makes a has_many association will use “person_id” as the default :foreign_key. |
| :primary_key | Specify the method that returns the primary key used for the association. By default this is id. |
| :dependent | Controls what happens to the associated objects when their owner is destroyed. Note that these are implemented as callbacks, and Rails executes callbacks in order. Therefore, other similar callbacks may affect the :dependent behavior, and the :dependent behavior may affect other callbacks. |
| :counter_cache | This option can be used to configure a custom named :counter_cache. You only need this option, when you customized the name of your :counter_cache on the belongs_to association. |
| :as | Specifies a polymorphic interface (See belongs_to). |
| :through | Specifies an association through which to perform the query. This can be any other type of association, including other :through associations. Options for :class_name, :primary_key and :foreign_key are ignored, as the association uses the source reflection. <br> If the association on the join model is a belongs_to, the collection can be modified and the records on the :through model will be automatically created and removed as appropriate. Otherwise, the collection is read-only, so you should manipulate the :through association directly. <br> If you are going to modify the association (rather than just read from it), then it is a good idea to set the :inverse_of option on the source association on the join model. This allows associated records to be built which will automatically create the appropriate join model records when they are saved. (See the 'Association Join Models' section above.) |
| :source | Specifies the source association name used by has_many :through queries. Only use it if the name cannot be inferred from the association. has_many :subscribers, through: :subscriptions will look for either :subscribers or :subscriber on Subscription, unless a :source is given. |
| :source_type | Specifies type of the source association used by has_many :through queries where the source association is a polymorphic belongs_to. |
| :validate | If false, don't validate the associated objects when saving the parent object. true by default. |
| :autosave | If true, always save the associated objects or destroy them if marked for destruction, when saving the parent object. If false, never save or destroy the associated objects. By default, only save associated objects that are new records. This option is implemented as a before_save callback. Because callbacks are run in the order they are defined, associated objects may need to be explicitly saved in any user-defined before_save callbacks. <br> Note that accepts_nested_attributes_for sets :autosave to true. |
| :inverse_of | Specifies the name of the belongs_to association on the associated object that is the inverse of this has_many association. Does not work in combination with :through or :as options. See ActiveRecord::Associations::ClassMethods's overview on Bi-directional associations for more detail. |

### 注意事项。

- :dependent 可选参数
  - :destroy causes all the associated objects to also be destroyed.

  - :delete_all causes all the associated objects to be deleted directly from the database (so callbacks will not be executed).

  - :nullify causes the foreign keys to be set to NULL. Callbacks are not executed.

  - :restrict_with_exception causes an exception to be raised if there are any associated records.

  - :restrict_with_error causes an error to be added to the owner if there are any associated objects.

If using with the :through option, the association on the join model must be a belongs_to, and the records which get deleted are the join records, rather than the associated records.


## 4) has_and_belongs_to_many

### 方法本身表示什么意思。

Specifies a many-to-many relationship with another class. This associates two classes via an intermediate join table. Unless the join table is explicitly specified as an option, it is guessed using the lexical order of the class names. So a join between Developer and Project will give the default join table name of “developers_projects” because “D” precedes “P” alphabetically.

### 引进了哪些方法，表示什么意思。

| 方法 | 解释 |
| -- | -- |
| collection(force_reload = false) | Returns an array of all the associated objects. An empty array is returned if none are found. |
| collection<<(object, …) | Adds one or more objects to the collection by creating associations in the join table (collection.push and collection.concat are aliases to this method). Note that this operation instantly fires update SQL without waiting for the save or update call on the parent object, unless the parent object is a new record. |
| collection.delete(object, …) | Removes one or more objects from the collection by removing their associations from the join table. This does not destroy the objects. |
| collection.destroy(object, …) | Removes one or more objects from the collection by running destroy on each association in the join table, overriding any dependent option. This does not destroy the objects. |
| collection=objects | Replaces the collection's content by deleting and adding objects as appropriate. |
| collection_singular_ids | Returns an array of the associated objects' ids. |
| collection_singular_ids=ids | Replace the collection by the objects identified by the primary keys in ids. |
| collection.clear | Removes every object from the collection. This does not destroy the objects. |
| collection.empty? | Returns true if there are no associated objects. |
| collection.size | Returns the number of associated objects. |
| collection.find(id) | Finds an associated object responding to the id and that meets the condition that it has to be associated with this object. Uses the same rules as ActiveRecord::Base.find. |
| collection.exists?(…) | Checks whether an associated object with the given conditions exists. Uses the same rules as ActiveRecord::Base.exists?. |
| collection.build(attributes = {}) | Returns a new object of the collection type that has been instantiated with attributes and linked to this object through the join table, but has not yet been saved. |
| collection.create(attributes = {}) | Returns a new object of the collection type that has been instantiated with attributes, linked to this object through the join table, and that has already been saved (if it passed the validation). |

### 有什么参数，表示什么意思，使用后有什么效果。

普通参数 **Scope**

You can pass a second argument scope as a callable (i.e. proc or lambda) to retrieve a specific set of records or customize the generated query when you access the associated collection.

Scope examples:

```ruby
has_and_belongs_to_many :projects, -> { includes :milestones, :manager }
has_and_belongs_to_many :categories, ->(category) {
  where("default_category = ?", category.name)
}
```

普通参数 **Extension**

The extension argument allows you to pass a block into a #has_and_belongs_to_many association. This is useful for adding new finders, creators and other factory-type methods to be used as part of the association.

Extension examples:

```ruby
has_and_belongs_to_many :contractors do
  def find_or_create_by_name(name)
    first_name, last_name = name.split(" ", 2)
    find_or_create_by(first_name: first_name, last_name: last_name)
  end
end
```
可选参数 **Options**

| 参数 | 解释 |
| -- | -- |
| :class_name | Specify the class name of the association. Use it only if that name can't be inferred from the association name. So has_and_belongs_to_many :projects will by default be linked to the Project class, but if the real class name is SuperProject, you'll have to specify it with this option. |
| :join_table | Specify the name of the join table if the default based on lexical order isn't what you want. **WARNING:** If you're overwriting the table name of either class, the table_name method MUST be declared underneath any has_and_belongs_to_many declaration in order to work. |
| :foreign_key | Specify the foreign key used for the association. By default this is guessed to be the name of this class in lower-case and “_id” suffixed. So a Person class that makes a has_and_belongs_to_many association to Project will use “person_id” as the default :foreign_key. |
| :association_foreign_key | Specify the foreign key used for the association on the receiving side of the association. By default this is guessed to be the name of the associated class in lower-case and “_id” suffixed. So if a Person class makes a has_and_belongs_to_many association to Project, the association will use “project_id” as the default :association_foreign_key. |
| :readonly | If true, all the associated objects are readonly through the association. |
| :validate | If false, don't validate the associated objects when saving the parent object. true by default. |
| :autosave | If true, always save the associated objects or destroy them if marked for destruction, when saving the parent object. If false, never save or destroy the associated objects. By default, only save associated objects that are new records. <br> Note that accepts_nested_attributes_for sets :autosave to true. |

### 注意事项。

- Note that this precedence is calculated using the < operator for String. This means that if the strings are of different lengths, and the strings are equal when compared up to the shortest length, then the longer string is considered of higher lexical precedence than the shorter one. For example, one would expect the tables “paper_boxes” and “papers” to generate a join table name of “papers_paper_boxes” because of the length of the name “paper_boxes”, but it in fact generates a join table name of “paper_boxes_papers”. Be aware of this caveat, and use the custom :join_table option if you need to. If your tables share a common prefix, it will only appear once at the beginning. For example, the tables “catalog_categories” and “catalog_products” generate a join table name of “catalog_categories_products”.

## 其它

上述对方法或参数的解释，仅供参考，实际以运行结果为准。

当不确定参数表示什么意思，使用后有什么效果时，请慎用，可以用其它确定/有把握的方法代替。

